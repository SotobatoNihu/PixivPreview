!function(e){var t={};function o(n){if(t[n])return t[n].exports;var p=t[n]={i:n,l:!1,exports:{}};return e[n].call(p.exports,p,p.exports,o),p.l=!0,p.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},o.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t){!function(e){var t={};function o(n){if(t[n])return t[n].exports;var p=t[n]={i:n,l:!1,exports:{}};return e[n].call(p.exports,p,p.exports,o),p.l=!0,p.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},o.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=6)}([function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.changeLayout=0]="changeLayout",e[e.popup_typeA=1]="popup_typeA",e[e.popup_typeB=2]="popup_typeB",e[e.openComment=3]="openComment"}(t.prop||(t.prop={})),function(e){e[e.image=0]="image",e[e.manga=1]="manga",e[e.caption=2]="caption"}(t.uiComponent||(t.uiComponent={})),function(e){e[e.top=0]="top",e[e.bookmark_new_illust=1]="bookmark_new_illust",e[e.discovery=2]="discovery",e[e.member_illust=3]="member_illust",e[e.member=4]="member",e[e.bookmark_detail=5]="bookmark_detail",e[e.bookmark_add=6]="bookmark_add",e[e.ranking=7]="ranking",e[e.bookmark_id=8]="bookmark_id",e[e.search=9]="search",e[e.bookmark=10]="bookmark",e[e.other=11]="other"}(t.pagetype||(t.pagetype={}))},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Manga=class{constructor(){this.followedUsersId=[],this.BOOKMARK_URL="https://www.pixiv.net/bookmark.php",this.CheckedPublic=!1,this.Checked=!1,this.artsLoaded=0,this.hits=0,this.isRunning=!1,this.lastImgId=" ",this.siteImgMaxWidth=150,this.mangaWidth=1200,this.imgsArr=[],this.DELTASCALE="mozInnerScreenX"in window?70:4}set LastImgId(e){this.lastImgId=e}getLastImgId(){return this.lastImgId}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),p=o(4),i=o(1);t.Util=class{static changeLayout(){document.getElementsByTagName("figure"),$("figure").before($("figcaption"))}static checkPageType(e){return e.match("https://www.pixiv.net/bookmark_new_illust.php?")?n.pagetype.bookmark_new_illust:e.match("https://www.pixiv.net/discovery?")?n.pagetype.discovery:e.match("https://www.pixiv.net/member_illust.php?")?n.pagetype.member_illust:e.match("https://www.pixiv.net/member.php?")?n.pagetype.member:e.match("https://www.pixiv.net/bookmark_detail.php?")?n.pagetype.bookmark_detail:e.match("https://www.pixiv.net/bookmark_add.php?")?n.pagetype.bookmark_add:e.match("https://www.pixiv.net/ranking.php?")?n.pagetype.ranking:e.match(/https:\/\/www\.pixiv\.net\/bookmark\.php\?id/)?n.pagetype.bookmark_id:e.match("https://www.pixiv.net/search.php")?n.pagetype.search:e.match("https://www.pixiv.net/bookmark.php?")?n.pagetype.bookmark:e.match("https://www.pixiv.net/")?n.pagetype.top:n.pagetype.other}static getAllowedFuncList(e){switch(e){case n.pagetype.top:return[n.prop.popup_typeB];case n.pagetype.bookmark_new_illust:case n.pagetype.discovery:return[n.prop.popup_typeA];case n.pagetype.member_illust:return[n.prop.popup_typeB,n.prop.changeLayout,n.prop.openComment];case n.pagetype.member:case n.pagetype.bookmark_detail:case n.pagetype.bookmark_add:case n.pagetype.bookmark_id:return[n.prop.popup_typeB];case n.pagetype.search:return[n.prop.popup_typeA];case n.pagetype.ranking:case n.pagetype.bookmark:return[n.prop.popup_typeB];default:return[]}}openComment(){let e=$("article");e.find("[aria-expanded='false']").click(),new MutationObserver(function(t,o){e.find("[aria-expanded='false']").click()}).observe(document,{childList:!0,subtree:!0})}setPopup(e,t){const o=new p.PopupUtil,l=o.getCaptionContainer(),s=o.getOuterContainer(document);document.body.appendChild(l),document.body.appendChild(s),e.isEnable(n.prop.popup_typeA)?($("body").on("mouseenter",o.getImgeSelector(n.prop.popup_typeA),function(){let t=this;$(this).attr("onclick","console.log();return false;"),$(this).on("click",function(){o.popupImg(e,s,t);const n=$(this).parent().parent().find("a").attr("href"),p=n.substring(n.indexOf("illust_id=")+"illust_id=".length);console.log("id:"+p),o.popupCaption(s,p)})}),$("body").on("mouseenter",o.getMangaSelector(n.prop.popup_typeA),function(){if(this.parentNode.firstChild.childNodes.length){$(this).attr("onclick","console.log();return false;");var e=this,t=this.parentNode.firstChild.firstChild.textContent;$(this).on("click",function(){o.popupManga(s,e,t);const n=$(this).parent().parent().find("a").attr("href"),p=n.slice(n.substring("illust_id=")+"illust_id=".length);console.log("id:"+p),o.popupCaption(s,p)})}})):e.isEnable(n.prop.popup_typeB)&&$("body").on("mouseenter",'a[href*="member_illust.php?mode=medium&illust_id="]',function(){if(1==this.childNodes.length&&"DIV"==this.childNodes[0].nodeName){var t=this.firstChild.firstChild;$(this).attr("onclick","console.log();return false;"),$(this).on("click",function(){o.popupImg(e,s,t);const n=t.getAttribute("data-id");o.popupCaption(s,n)})}else if(this.children[1]&&"page-count"==this.children[1].className){new i.Manga;var n=this.firstChild.firstChild,p=this.children[1].children[1].textContent;$(this).attr("onclick","console.log();return false;"),$(this).on("click",function(){o.popupManga(s,n,p),parseInt($(s).css("top")),parseInt($(s).css("left"));const e=n.getAttribute("data-id");o.popupCaption(s,e)})}});const a=()=>{const e=document.getElementById("captionContainer");e.innerText=null,e.style.display="none";const t=s.children;for(const e of t)e.style.display="none";s.style.display="none",s.textContent=null,s.style.display="none"};s.onmouseleave=function(){0==$(l).find("a").length?a():setTimeout(a(),1e3)},l.onmouseleave=function(){l.innerText=null,l.style.display="none"},window.onresize=function(){s.style.maxWidth=document.body.clientWidth-80}}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0);t.Setting=class{constructor(e){const t=JSON.parse(e);this.changeLayout=null==t.changeLayout||t.changeLayout,this.openComment=null==t.openComment||t.openComment,this.popup=null==t.popup||t.popup,this.uiComponent=[n.uiComponent.image,n.uiComponent.manga,n.uiComponent.caption]}set setData(e){this.changeLayout=null==e.changeLayout||e.changeLayout,this.openComment=null==e.openComment||e.openComment,this.popup=null==e.popup||e.popup}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(0),p=o(1);t.PopupUtil=class{constructor(){}getImgContainer(){let e=document.createElement("div");return e.id="imgContainer",e.style.display="block",e.style.zIndex="1000",e.style.backgroundColor="#222",e.style.maxWidth="1200px",e.style.whiteSpace="nowrap",e.style.padding="5px",e.style.margin="5px",e}getImageElement(){let e=document.createElement("img");return e.id="popupImg",e}getMangaContainer(e){let t=e.createElement("div");t.id="mangaContainer",t.style.display="block",t.style.zIndex="1500",t.style.backgroundColor="#111",t.style.overflowX="auto",t.style.maxWidth="1200px",t.style.top="0px",t.style.left="0px",t.style.whiteSpace="nowrap";let o=e.body.clientWidth-80;return t.style.maxWidth=o+"px",t}getOuterContainer(e){let t=e.createElement("div");e.body.appendChild(t);let o=e.createElement("div");o.id="outerContainer",t.appendChild(o),o.style.position="absolute",o.style.display="block",o.style.zIndex="1000",o.style.padding="5px",o.style.backgroundColor="#111",o.style.maxWidth="1200px",o.style.left="0px",o.style.left="0px";let n=e.body.clientWidth-80;return o.style.maxWidth=n+"px",o}getCaptionContainer(){let e=document.createElement("div");return e.id="captionContainer",(e=document.createElement("div")).style.whiteSpace="nowrap",e.style.display="block",e.style.zIndex="1001",e.style.position="absolute",e.style.padding="5px",e.style.maxWidth="1200px",e.style.top="0px",e.style.left="0px",e.style.backgroundColor="#FFF",e}getImgeSelector(e){return'a[href*="member_illust.php?mode=medium&illust_id="] > div:only-child'}getMangaSelector(e){return'a[href*="member_illust.php?mode=medium&illust_id="] > div:nth-child(2) '}popupImg(e,t,o){const p=t.children;for(const e of p)e.style.display="none";t.textContent=null;const i=this.getImgContainer();t.appendChild(i);const l=this.getImageElement();i.appendChild(l),t.style.top=this.getOffsetRect(o.parentNode.parentNode).top+"px",i.style.top=t.style.top,l.src=this.parseImgUrl(o);const s=this.getOffsetRect(o.parentNode.parentNode);i.style.top=this.getOffsetRect(o.parentNode).top+"px",t.style.top=i.style.top;let a=s.left,r=(e.pageType===n.pagetype.ranking?o.clientWidth:o.parentNode.parentNode.clientWidth)/e.siteImgMaxWidth*600+5;i.style.left=document.body.clientWidth-a<r?document.body.clientWidth-r+"px":a+"px",t.style.left=i.style.left,$(o).hasClass("on")?$(t).css("background","rgb(255, 64, 96)"):$(t).css("background","rgb(34, 34, 34)"),i.style.display="block",t.style.display="block"}popupCaption(e,t){let o=this.getCaptionContainer();const n="captionContainer";let p;if(null!=document.getElementById(n)?((p=document.getElementById(n)).innerText=null,p.style.display="none"):((p=o).id=n,$(p).insertBefore(e)),p.style.left=e.style.left,void 0===t||0===t.length)return;const i="https://www.pixiv.net/ajax/illust/"+t;console.log("url:"+i),fetch(i).then(function(e){return e.json()}).then(function(t){const o=new Date(t.body.createDate),n=`<p><i>upload:${o.getFullYear()}/${o.getMonth()+1}/${o.getDate()} ${o.getHours()}:${o.getMinutes()}</i></p>`,i=`<p><i>like :${t.body.likeCount}, bookmark:${t.body.bookmarkCount}, view: ${t.body.viewCount}</i></p>`;p.style.display="block",p.style.width=e.clientWidth+"px",p.style.backgroundColor="white",p.style.wordWrap="break-word",p.style.wordBreak="break-all",p.style.whiteSpace="normal",p.innerHTML=t.body.description+n+i;const l=parseInt(e.style.top)-parseInt(p.getBoundingClientRect().height);p.style.top=l+"px"})}popupManga(e,t,o){const n=this.getMangaContainer(document);e.appendChild(n);const i=new p.Manga,l=e.children;for(const e of l)e.style.display="none";e.style.top=this.getOffsetRect(t.parentNode.parentNode).top+"px",n.style.top=e.style.top,$(t).hasClass("on")?$(e).css("background","rgb(255, 64, 96)"):$(e).css("background","rgb(34, 34, 34)"),this.imgsArrInit(e,n,i,this.parseImgUrl(t),+o),n.style.display="block",e.style.display="block",this.setScrool(e,n,i)}parseImgUrl(e){let t=e.src?e.src:e.style.backgroundImage.slice(5,-2);return t=t.replace(/\/...x...\//,"/600x600/")}getOffsetRect(e){let t=e.getBoundingClientRect(),o=document.body,n=document.documentElement,p=window.pageYOffset||n.scrollTop||o.scrollTop,i=window.pageXOffset||n.scrollLeft||o.scrollLeft,l=n.clientTop||o.clientTop||0,s=n.clientLeft||o.clientLeft||0,a=t.top+p-l,r=t.left+i-s;return{top:Math.round(a),left:Math.round(r)}}imgsArrInit(e,t,o,n,p){let i=document.body.clientWidth-600*p;i>0&&(e.style.left=i/2-10+"px");let l=this.getImgId(n);if(l!==o.getLastImgId()){o.imgsArr.forEach(e=>{e.src=""}),o.lastImgId=l;for(let e=0;e<p;e++)o.imgsArr[e]||(o.imgsArr[e]=document.createElement("img"),t.appendChild(o.imgsArr[e])),o.imgsArr[e].src=n.replace("p0","p"+e)}}getImgId(e){return e.substring(e.lastIndexOf("/")+1,e.indexOf("_"))}setScrool(e,t,o){t.onwheel=function(n){n.deltaY<0&&e.getBoundingClientRect().top<0?e.scrollIntoView({block:"start",behavior:"smooth"}):n.deltaY>0&&e.getBoundingClientRect().bottom>document.documentElement.clientHeight&&e.scrollIntoView({block:"end",behavior:"smooth"});let p=t.scrollLeft;(p>0&&n.deltaY<0||p<t.scrollWidth-t.clientWidth&&n.deltaY>0)&&(n.preventDefault(),t.scrollLeft+=n.deltaY*o.DELTASCALE)}}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(2),p=o(0);t.Page=class{constructor(e){this.util=new n.Util,this.URL=e,this.pagetype=n.Util.checkPageType(e),this.siteImgMaxWidth=this.pagetype===p.prop.popup_typeA?200:150,this.alloedFunclist=n.Util.getAllowedFuncList(this.pagetype)}set setURL(e){this.URL=e,this.pagetype=n.Util.checkPageType(e)}get getPagetype(){return this.pagetype}get getURL(){return this.URL}get getFunclist(){return this.alloedFunclist}isEnable(e){return this.alloedFunclist.indexOf(e)>-1}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=o(5),p=o(0),i=o(2),l=o(3);let s,a=new n.Page(document.URL),r=new i.Util;(async()=>{return await GM.getValue("pixiv_viewutil_setting",JSON.stringify({changeLayout:!0,openComment:!0,popup:!0}))})().then(e=>s=new l.Setting(e)),window.onload=(()=>{console.log("popup set"),s.popup&&a.isEnable(p.prop.popup_typeA)?(r.setPopup(a,s),console.log("popup  A is enable")):s.popup&&a.isEnable(p.prop.popup_typeB)&&(r.setPopup(a,s),console.log("popup  B is enable")),console.log("pagetype:"+a.pagetype.toString()),i.Util.changeLayout&&a.isEnable(p.prop.changeLayout)&&(i.Util.changeLayout(),console.log("layout chainged")),s.openComment&&a.isEnable(p.prop.openComment)&&(r.openComment(),console.log("comment opend"));const e=document.getElementsByTagName("a");for(const t of e)t.addEventListener("click",()=>{let e=new n.Page(document.URL);console.log("pagetype:"+e.pagetype.toString()),i.Util.changeLayout&&e.isEnable(p.prop.changeLayout)&&(i.Util.changeLayout(),console.log("layout chainged.")),s.openComment&&e.isEnable(p.prop.openComment)&&(r.openComment(),console.log("comment opend."))})})}])}]);